# Druid

## 数据库连接池

提供监控和扩展功能

## 问题总结

每个线程都会开启一个tomcat进程，如果没有注册机制或内存不够时，无法创建druid实例。

[Tomcat注册没有设置](https://blog.csdn.net/shenxiaomo1688/article/details/105835641)

[Oracle监听没有开启](https://blog.csdn.net/weixin_42648692/article/details/86595509)

[设置JVM内存](https://github.com/alibaba/druid/issues/865)

## 配置参数
| 配置                              | 缺省值  | 描述                                                                                                                                                                         | 推荐说明                                                                                                                                                                                              |
|-----------------------------------|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| initial-size                      | 0       | 初始化时建立物理连接的个数。初始化发生在显示调用init方法，或者第一次getConnection时                                                                                          | 连接数=(核心数 * 2) + 有效磁盘数)                                                                                                                                                                     |
| min-idle                          |         | 最小连接池数量                                                                                                                                                               | 与initialSize一致                                                                                                                                                                                     |
| max-idle                          | 8       | 最大连接池数量                                                                                                                                                               |                                                                                                                                                                                                       |
| max-wait                          |         | 获取连接时最大等待时间，单位毫秒。配置了maxWait之后，缺省启用公平锁，并发效率会有所下降，如果需要可以通过配置useUnfairLock属性为true使用非公平锁                             |                                                                                                                                                                                                       |
| use-unfair-lock                   | false   | 如果设置了maxWait，则启用公平锁                                                                                                                                              |                                                                                                                                                                                                       |
| time-between-eviction-runs-millis | 60000   | 在空闲连接回收器线程运行期间休眠时间，它决定线程多久验证空闲连接或丢弃连接的频率                                                                                             | 源码上看，是通过validation-query配置的语句语句检测连接的有效性，如果连接失败了则丢弃                                                                                                                  |
| min-evictableIdle-time-millis     | 1800000 | 连接在池中保持空闲而不被回收的最小时间                                                                                                                                       |                                                                                                                                                                                                       |
| validation-query                  |         | 用来检测连接是否有效的sql，要求是一个查询语句。如果validationQuery为null，testOnBorrow、testOnReturn、testWhileIdle都不会其作用false                                         | 如果检测到已知驱动后，会使用MySqlValidConnectionChecker类进行有效检测，走的是ping策略，而不是该配置，哪怕没有配置也会走默认的 “select 1”，前提是使用MySqlValidConnectionChecker，不然是直接返回true的 |
| validation-query-timeout          | -1      | 检测连接超时时间                                                                                                                                                             | 虽然这里默认是-1，但是实际代码会设置成1s的时间                                                                                                                                                        |
| test-on-borrow                    | false   | 申请连接时执行validationQuery检测连接是否有效，做了这个配置会降低性能                                                                                                        |                                                                                                                                                                                                       |
| test-while-idle                   | true    | 建议配置为true，不影响性能，并且保证安全性。申请连接的时候检测，如果空闲时间大于timeBetweenEvictionRunsMillis，执行validationQuery检测连接是否有效                           |                                                                                                                                                                                                       |
| test-on-return                    | false   | 归还连接时执行validationQuery检测连接是否有效，做了这个配置会降低性能                                                                                                        |                                                                                                                                                                                                       |
| pool-prepared-statements          | false   | 是否缓存preparedStatement，也就是PSCache。PSCache对支持游标的数据库性能提升巨大，比如说oracle。在mysql下建议关闭                                                             |                                                                                                                                                                                                       |
| max-open-prepared-statements      | -1      | 要启用PSCache，必须配置大于0，当大于0时，poolPreparedStatements自动触发修改为true。在Druid中，不会存在Oracle下PSCache占用内存过多的问题，可以把这个数值配置大一些，比如说100 |                                                                                                                                                                                                       |
| filter-class-names                |         |                                                                                                                                                                              |                                                                                                                                                                                                       |
| flter.stat.slow-sql-millis        |         |                                                                                                                                                                              |                                                                                                                                                                                                       |
